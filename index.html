<!DOCTYPE html>
<!--[if lt IE 7]><html class="ie ie6" lang="en"><![endif]-->
<!--[if IE 7]><html class="ie ie7" lang="en"><![endif]-->
<!--[if IE 8]><html class="ie ie8" lang="en"><![endif]-->
<!--[if gt IE 8]><!--><html lang="en"><!--<![endif]-->
  <head>

    <title></title>

    <!-- Base meta //-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <link type="text/plain" rel="author" href="humans.txt" />

    <!-- social medias //-->
    <!-- fb -->
    <meta property="og:url" content="" />
    <meta property="og:title" content="Home"/>
    <meta property="og:description" content=""/>
    <meta property="og:image" content="" />

    <!-- twitter -->
    <meta name="twitter:card" value="summary" />
    <meta name="twitter:site" value="" />
    <meta name="twitter:url" content="" />
    <meta name="twitter:title" content="Home" />
    <meta name="twitter:description" content="" />
    <meta name="twitter:image" content="" />

    <!-- mobile //-->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="x-rim-auto-match" content="none" />

    <!-- css //-->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link href="styles/styles.css" media="screen, print" rel="stylesheet" type="text/css"  />

    <link rel="icon" type="image/x-icon" href="favicon.ico">
  </head>
<body>
    <div id='main' class='container-fluid'>
        <div class='row section login'>
            <div class='col-xs-offset-2 col-xs-8'>
                <h1 class='text-center'>Rose</h1>
                <p class='text-center'>Find a name you both agree on.</p>
                <hr/>
                <form id='create'>
                  <div class="form-group">
                    <input type="email" class="form-control input-lg" id="email" placeholder="Co-parent's email" value="meandmybadself@gmail.com">
                  </div>
                  <p><b>Show us:</b></p>
                  <div class="radio">
                    <label>
                      <input type="radio" name="gender" id="gender" value="all" checked>
                      all names.
                    </label>
                  </div>
                  <div class="radio">
                    <label>
                      <input type="radio" name="gender" id="gender" value="f">
                      girl names.
                    </label>
                  </div>
                  <div class="radio">
                    <label>
                      <input type="radio" name="gender" id="gender" value="m">
                      boy names.
                    </label>
                  </div>
                  <hr/>
                  <button type="submit" id='createUser' class="btn btn-success btn-lg">Find a name</button>
                </form>
            </div>
        </div>
        <div class='row section name'>
            <div class='col-xs-12 name-container'>
                <h1 id='name'></h1>
                <div id='matchCountContainer'>
                    <div id='matchCount'></div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.17.0/TweenMax.min.js"></script>
    <script type="text/javascript" src="scripts/hashids.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.4/hammer.min.js"></script>
    <script type="text/javascript">

        function createUser(email, gender) {
            $('#createUser').addClass('disabled');
            //create a uid.
            var h   = new Hashids("Cock. Balls. http://www.imdb.com/title/tt0302886/");
            var int = Math.floor(Math.random() * 1000000);
            //uid-email-gender-user
            var uid = h.encode(int) + '-' + email + '-' + gender + '-0';
            window.uid = uid;
            //send an email to the co-parent.
            $.post("create/",
                {'uid':uid, 'email':$('#email').val()},
                onUserCreated,
                "json"
                ).error(onError);
        }

        function onError() {
            console.log('onError', arguments);
            alert("Something's broken.");
           // alert('duh...');
        }

        function onUserCreated() {
            console.log('onUserCreated');
            setUser(window.uid);
        }

        function onSwipe() {
            console.log('onSwipe', window.currentName);
        }
        function onTap(e) {
            //console.log('onTap', window.currentName, arguments);
            var x = e.pointers[0].pageX;
            var swh = window.innerWidth / 2;
            if (x > -1 && x < swh) {
                swipeLeft();
            } else {
                swipeRight();
            }
        }

        function swipeRight() {
            console.log('swipeRight');
            $.post("vote/",
                {'uid':window.uid, 'name':window.currentName, 'user':window.currentUser},
                updateCount,
                "json"
            ).error(onError);

            showNextName();
        }

        function updateCount(data) {
            console.log('updateCount', data.matches);
            if (data.matches) {
                $('#matchCount').text(data.matches);
                $('#matchCountContainer').addClass("active");

            }
        }

        function swipeLeft() {
            showNextName();
        }

        function setUser(uid) {
            $('.login').hide();

            //Set up Hammer.
            window.h = new Hammer(document.getElementById('main'));
            window.h.get('swipe').set({direction:Hammer.DIRECTION_HORIZONTAL});
            window.h.on('swipe', onSwipe);
            window.h.on('tap', onTap);

            //Do we have the uid in ls?
            var d = localStorage.getItem(uid);
            if (d) {
                //yep.
                //parse & keep playing.
                showNextName();

            } else {

                //nope.
                window.uid      = uid;

                //parse deets.
                var uidParts    = uid.split("-");
                window.user     = uidParts.pop();
                window.gender   = uidParts.pop();

                localStorage.setItem("id", uid);
                localStorage.setItem("user", window.user);
                //load gender data.
                $.getJSON("data/" + gender + ".json").success(onNamesLoaded);
            }
        }

        function onNamesLoaded(data,status) {
            //console.log('onNamesLoaded');
            //Shuffle it up.
            var names = shuffle(data);
            //Stow that shit away in ls.
            localStorage.setItem(window.uid, JSON.stringify(names));

            //Get this party started.
            showNextName();
        }

        function showNextName() {
            var names = $.parseJSON(localStorage.getItem(window.uid));

            if (names && names.length) {
                var name = names.pop();
                window.currentName = name;
                localStorage.setItem(window.uid,JSON.stringify(names));

                $('.section.name').show();
                $('#name').text(window.currentName);
            }
        }

        function shuffle(array) {
          var currentIndex = array.length, temporaryValue, randomIndex ;

          // While there remain elements to shuffle...
          while (0 !== currentIndex) {
            // Pick a remaining element...
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex -= 1;

            // And swap it with the current element.
            temporaryValue = array[currentIndex];
            array[currentIndex] = array[randomIndex];
            array[randomIndex] = temporaryValue;
          }

          return array;
        }

        $(function() {
            //Do we have stored data?
            var id = localStorage.getItem("id");
            var user = localStorage.getItem("user");
            if (id && user) {
                window.uid = id;
                window.user = user;
                setUser(id);
            } else {

                $('#create').submit(function(e) {
                    //stop being a form, form.
                    e.preventDefault();

                    //Yank values from form.
                    var email = $('#email').val(), gender = $('input[name=gender]:checked').val();
                    createUser(email, gender);
                });

                $('#email').focus();
            }
        });
    </script>

</body>
</html>